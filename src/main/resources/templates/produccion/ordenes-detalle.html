<!doctype html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="utf-8">
  <title>Detalle orden de producci√≥n ¬∑ RIPNEL</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
          rel="stylesheet">
  <link th:href="@{/css/app.css}" rel="stylesheet">
</head>
<body th:attr="data-bs-theme=${theme}">

<div th:replace="~{_nav :: bar('Producci√≥n')}"></div>

<main class="container-xxl py-4">

  <!-- CABECERA ORDEN -->
  <section class="card mb-4 p-3">
    <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
      <div>
        <h1 class="h4 mb-1 fw-semibold">
          Orden de producci√≥n
          <span class="text-secondary">#</span>
          <span th:text="${order.number != null ? order.number : order.code}">PO-0001</span>
        </h1>
        <p class="text-secondary small mb-0">
          Taller:
          <strong th:text="${order.workshop != null ? order.workshop.name : '‚Äî'}">
            Taller Central
          </strong>
          ¬∑ Inicio:
          <strong th:text="${order.startDate}">2025-11-21</strong>
          ¬∑ Fin:
          <strong th:text="${order.endDate != null ? order.endDate : order.dueDate}">‚Äî</strong>
        </p>
      </div>

      <div class="d-flex flex-wrap gap-2">
        <span class="badge align-self-center"
              th:classappend="${
                  order.status.name() == 'PLANNED' or order.status.name() == 'PENDING' ? ' text-bg-secondary' :
                  (order.status.name() == 'IN_PROGRESS' ? ' text-bg-warning' :
                   (order.status.name() == 'DONE' or order.status.name() == 'FINISHED' ? ' text-bg-success' :
                    ' text-bg-danger'))
              }"
              th:text="${order.status}">
          PLANNED
        </span>

        <!-- Botones directos seg√∫n estado -->
        <a th:if="${order.status.name() == 'PLANNED' or order.status.name() == 'PENDING'}"
           th:href="@{|/produccion/ordenes/${order.id}/iniciar|}"
           class="btn btn-warning btn-sm">
          Iniciar producci√≥n
        </a>

        <a th:if="${order.status.name() == 'IN_PROGRESS'}"
           th:href="@{|/produccion/ordenes/${order.id}/consumir|}"
           class="btn btn-outline-danger btn-sm">
          Consumir materiales
        </a>

        <a th:if="${order.status.name() == 'IN_PROGRESS'}"
           th:href="@{|/produccion/ordenes/${order.id}/finalizar|}"
           class="btn btn-success btn-sm">
          Finalizar orden
        </a>

        <a th:href="@{/produccion/ordenes}" class="btn btn-outline-secondary btn-sm">
          Volver a lista
        </a>
      </div>
    </div>
  </section>

  <div class="row g-4">

    <!-- IZQUIERDA: agregar productos a fabricar -->
    <section class="col-12 col-lg-5">
      <div class="card p-3">
        <h2 class="h5 mb-3">Agregar producto a fabricar</h2>

        <form th:action="@{|/produccion/ordenes/${order.id}/items|}"
              th:object="${itemForm}"
              method="post"
              class="row g-3">

          <input type="hidden" th:field="*{orderId}" th:value="${order.id}"/>

          <!-- Buscador de variante -->
          <div class="col-12">
            <label class="form-label">Buscar variante (SKU / nombre / color / talla)</label>
            <input type="text"
                   id="variantSearch"
                   class="form-control"
                   placeholder="Ej. LEG-SUPLEX, negro M, polo b√°sico..."
                   autocomplete="off">
            <div class="form-text">
              Escribe para filtrar la lista de variantes.
            </div>
          </div>

          <!-- Select de variantes -->
          <div class="col-12">
            <label class="form-label">Variante (SKU)</label>
            <select class="form-select" th:field="*{variantId}" id="variantSelect">
              <option value="">Selecciona una variante...</option>
              <option th:each="v : ${variants}"
                      th:value="${v.id}"
                      th:text="${v.sku + ' ¬∑ ' + v.product.name + ' ¬∑ ' + v.color.name + ' / ' + v.size.code}">
                LEG-SUPLEX-BLK-M ¬∑ Leggings Deportivo Suplex ¬∑ Negro / M
              </option>
            </select>
          </div>

          <!-- Cantidad -->
          <div class="col-12 col-md-6">
            <label class="form-label">Cantidad a producir</label>
            <input type="number" min="1" step="1"
                   class="form-control"
                   th:field="*{quantity}">
          </div>

          <div class="col-12 d-flex gap-2 mt-2">
            <button type="submit" class="btn btn-primary">
              Agregar producto
            </button>
          </div>

        </form>

        <p class="text-secondary small mt-3 mb-0">
          Estos productos se usar√°n para calcular el consumo de materiales a partir de la BOM.
        </p>
      </div>
    </section>

    <!-- DERECHA: lista de √≠tems + consumos -->
    <section class="col-12 col-lg-7">

      <!-- Tabla de √≠tems -->
      <div class="card p-3 mb-3">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h2 class="h5 mb-0">Productos a fabricar</h2>
        </div>

        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
            <tr>
              <th>SKU</th>
              <th>Producto</th>
              <th>Color / Talla</th>
              <th class="text-end">Cantidad</th>
            </tr>
            </thead>

            <tbody>
            <tr th:if="${#lists.isEmpty(order.items)}">
              <td colspan="4" class="text-center text-secondary py-3">
                A√∫n no hay productos asignados a esta orden.
              </td>
            </tr>

            <tr th:each="it : ${order.items}">
              <td class="small fw-semibold" th:text="${it.product.sku}">
                LEG-SUPLEX-BLK-M
              </td>
              <td th:text="${it.product.product.name}">
                Leggings Deportivo Suplex
              </td>
              <td th:text="${it.product.color.name + ' / ' + it.product.size.code}">
                Negro / M
              </td>
              <td class="text-end fw-semibold" th:text="${it.quantity}">
                50
              </td>
            </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Tabla de consumos -->
      <div class="card p-3">
        <h2 class="h5 mb-2">Consumo de materiales</h2>
        <p class="text-secondary small mb-2">
          Se llena cuando se ejecuta la acci√≥n
          <strong>‚ÄúConsumir materiales‚Äù</strong>.
        </p>

        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
            <tr>
              <th>C√≥digo</th>
              <th>Material</th>
              <th class="text-end">Cantidad usada</th>
            </tr>
            </thead>

            <tbody>
            <tr th:if="${#lists.isEmpty(order.consumptions)}">
              <td colspan="3" class="text-center text-secondary py-3">
                A√∫n no se ha registrado consumo de materiales para esta orden.
              </td>
            </tr>

            <tr th:each="mc : ${order.consumptions}">
              <td class="small fw-semibold" th:text="${mc.material.code}">
                MAT-SUPLEX-NEG
              </td>
              <td th:text="${mc.material.name}">
                Tela suplex negro
              </td>
              <td class="text-end fw-semibold" th:text="${mc.quantityUsed}">
                120.00
              </td>
            </tr>
            </tbody>
          </table>
        </div>
      </div>

    </section>

  </div><!-- row -->

</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
  // üîé B√∫squeda simple sobre el select de variantes
  (function() {
    const input = document.getElementById('variantSearch');
    const select = document.getElementById('variantSelect');
    if (!input || !select) return;

    input.addEventListener('input', function () {
      const filter = this.value.toLowerCase();

      Array.from(select.options).forEach((opt, index) => {
        if (index === 0) {
          // primera opci√≥n (placeholder) siempre visible
          opt.hidden = false;
          return;
        }
        const text = opt.text.toLowerCase();
        opt.hidden = !text.includes(filter);
      });

      // Si hay al menos una opci√≥n visible distinta del placeholder,
      // seleccionamos la primera visible.
      const firstVisible = Array.from(select.options).find((opt, idx) =>
              idx > 0 && !opt.hidden
      );
      if (firstVisible) {
        select.value = firstVisible.value;
      }
    });
  })();
</script>

</body>
</html>
